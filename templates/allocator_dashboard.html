<!-- templates/allocator_dashboard.html -->
{% extends "base.html" %}
{% block title %}Allocator Dashboard - Student Allotment{% endblock %}

{% block content %}
<style>
  .card-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  }
  
  .card {
    border-radius: 12px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  }
  
  .stat-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
  }
  
  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 0;
  }
  
  .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-top: 0.5rem;
  }
  
  .btn {
    border-radius: 8px;
    padding: 0.5rem 1.25rem;
    font-weight: 500;
    transition: all 0.3s;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  .btn-outline-primary {
    border: 2px solid #667eea;
    color: #667eea;
  }
  
  .btn-outline-primary:hover {
    background: #667eea;
    color: white;
  }
  
  .table-responsive {
    border-radius: 8px;
    overflow: hidden;
  }
  
  .table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .table thead th {
    border: none;
    padding: 1rem;
    font-weight: 600;
  }
  
  .table tbody tr {
    transition: background-color 0.2s;
  }
  
  .table tbody tr:hover {
    background-color: #f8f9fa;
  }
  
  .badge {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-weight: 500;
  }
  
  .badge-success {
    background: #10b981;
  }
  
  .badge-pending {
    background: #f59e0b;
  }
  
  .badge-rejected {
    background: #ef4444;
  }
  
  .alert {
    border-radius: 8px;
    border: none;
  }
  
  .alert-success {
    background: #d1fae5;
    color: #065f46;
  }
  
  .alert-danger {
    background: #fee2e2;
    color: #991b1b;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }
  
  .icon-primary {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }
  
  .icon-success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
  }
  
  .empty-state i {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 1rem;
  }
</style>

<div class="card card-hero p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
      <h2 class="mb-1">Allocator Dashboard</h2>
      <small style="opacity: 0.9;">Run allocation and manage student assignments</small>
    </div>
    <div class="d-flex gap-2">
      <button id="refreshBtn" class="btn btn-outline-light">
        <i class="fa fa-sync me-2"></i>Refresh
      </button>
    </div>
  </div>
</div>

<div class="row mb-4 g-3">
  <div class="col-lg-8">
    <div class="card p-4">
      <div class="d-flex align-items-center mb-3">
        <div class="icon-wrapper icon-primary me-3">
          <i class="fa fa-cogs"></i>
        </div>
        <h5 class="mb-0">Run Allocation</h5>
      </div>
      
      <form id="allocateForm">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Number of students to allocate</label>
            <input id="numAllocate" class="form-control form-control-lg" type="number" min="1" value="10" placeholder="Enter number" />
          </div>
          <div class="col-md-6">
            <button id="allocateBtn" class="btn btn-primary btn-lg w-100" type="submit">
              <i class="fa fa-play me-2"></i>Start Allocation
            </button>
          </div>
        </div>
      </form>
      
      <div id="allocResult" class="mt-3"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="stat-card">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <p class="stat-number" id="statsNumber">0</p>
          <p class="stat-label mb-0">Total Allocations</p>
        </div>
        <div>
          <i class="fa fa-users" style="font-size: 3rem; opacity: 0.3;"></i>
        </div>
      </div>
      <button id="refreshStats" class="btn btn-light btn-sm mt-3">
        <i class="fa fa-sync me-1"></i>Refresh Stats
      </button>
    </div>
  </div>
</div>

<div class="card p-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div class="d-flex align-items-center">
      <div class="icon-wrapper icon-success me-3">
        <i class="fa fa-list"></i>
      </div>
      <h5 class="mb-0">Allocated Students</h5>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-secondary" id="tableCount">0 records</span>
      <button id="exportPdfBtn" class="btn btn-outline-primary btn-sm">
        <i class="fa fa-file-pdf me-1"></i>Export PDF
      </button>
      <button id="downloadBtn" class="btn btn-outline-primary btn-sm">
        <i class="fa fa-file-csv me-1"></i>Export CSV
      </button>
    </div>
  </div>
  
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="allocTable">
      <thead>
        <tr>
          <th>Allotment ID</th>
          <th>Student ID</th>
          <th>Student Name</th>
          <th>Course</th>
          <th>College</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="allocTbody">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>
  
  <div id="emptyState" class="empty-state" style="display: none;">
    <i class="fa fa-inbox"></i>
    <p class="mb-0">No allocations found</p>
    <small>Start by running an allocation above</small>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script>
// Fetch and display allocations
async function fetchAllocations() {
  try {
    const res = await fetch('/allocator/allocations');
    const data = await res.json();
    const tbody = document.getElementById('allocTbody');
    const emptyState = document.getElementById('emptyState');
    const tableCount = document.getElementById('tableCount');
    
    tbody.innerHTML = '';
    
    if (data.length === 0) {
      emptyState.style.display = 'block';
      document.querySelector('.table-responsive').style.display = 'none';
      tableCount.textContent = '0 records';
      return;
    }
    
    emptyState.style.display = 'none';
    document.querySelector('.table-responsive').style.display = 'block';
    tableCount.textContent = `${data.length} record${data.length !== 1 ? 's' : ''}`;
    
    data.forEach(r => {
      const tr = document.createElement('tr');
      const statusClass = getStatusClass(r.allotment_status);
      tr.innerHTML = `
        <td><strong>#${r.allotment_id ?? 'N/A'}</strong></td>
        <td>${r.student_id ?? 'N/A'}</td>
        <td>${r.student_name ?? 'N/A'}</td>
        <td>${r.course_name ?? 'N/A'}</td>
        <td>${r.college_name ?? 'N/A'}</td>
        <td><span class="badge ${statusClass}">${r.allotment_status ?? 'N/A'}</span></td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteAlloc(${r.allotment_id})" title="Delete allocation">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Error fetching allocations:', error);
    showAlert('Failed to fetch allocations', 'danger');
  }
}

// Get status badge class
function getStatusClass(status) {
  if (!status) return 'badge-secondary';
  const statusLower = status.toLowerCase();
  if (statusLower.includes('allocated') || statusLower.includes('confirmed')) return 'badge-success';
  if (statusLower.includes('pending') || statusLower.includes('waiting')) return 'badge-pending';
  if (statusLower.includes('rejected') || statusLower.includes('cancelled')) return 'badge-rejected';
  return 'bg-secondary';
}

// Delete allocation
async function deleteAlloc(id) {
  if (!confirm('Are you sure you want to delete this allocation?')) return;
  
  try {
    const res = await fetch('/allocator/delete/' + id, { method: 'POST' });
    const j = await res.json();
    
    if (j.success) {
      showAlert('Allocation deleted successfully', 'success');
      await fetchAllocations();
      updateStats();
    } else {
      showAlert('Error: ' + (j.error || 'Unknown error occurred'), 'danger');
    }
  } catch (error) {
    console.error('Error deleting allocation:', error);
    showAlert('Failed to delete allocation', 'danger');
  }
}

// Run allocation
async function runAllocate(e) {
  e.preventDefault();
  
  const num = parseInt(document.getElementById('numAllocate').value || '0', 10);
  if (!num || num < 1) {
    showAlert('Please enter a valid number of students', 'danger');
    return;
  }
  
  const allocateBtn = document.getElementById('allocateBtn');
  const originalHTML = allocateBtn.innerHTML;
  allocateBtn.disabled = true;
  allocateBtn.innerHTML = '<span class="loading-spinner me-2"></span>Allocating...';
  
  try {
    const form = new FormData();
    form.append('num_to_allocate', num);
    const res = await fetch('/allocator/allocate', { method: 'POST', body: form });
    const j = await res.json();
    
    if (j.success) {
      showAlert(`Successfully allocated ${j.allocated_count} student${j.allocated_count !== 1 ? 's' : ''}`, 'success');
      await fetchAllocations();
      updateStats();
    } else {
      showAlert('Error: ' + (j.error || 'Unknown error occurred'), 'danger');
    }
  } catch (error) {
    console.error('Error running allocation:', error);
    showAlert('Failed to run allocation', 'danger');
  } finally {
    allocateBtn.disabled = false;
    allocateBtn.innerHTML = originalHTML;
  }
}

// Update statistics
async function updateStats() {
  try {
    const res = await fetch('/allocator/allocations');
    const data = await res.json();
    const statsNumber = document.getElementById('statsNumber');
    
    // Animate number change
    const currentNum = parseInt(statsNumber.textContent);
    const targetNum = data.length;
    animateNumber(statsNumber, currentNum, targetNum, 500);
  } catch (error) {
    console.error('Error updating stats:', error);
  }
}

// Animate number change
function animateNumber(element, start, end, duration) {
  const range = end - start;
  const increment = range / (duration / 16);
  let current = start;
  
  const timer = setInterval(() => {
    current += increment;
    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
      element.textContent = end;
      clearInterval(timer);
    } else {
      element.textContent = Math.floor(current);
    }
  }, 16);
}

// Show alert message
function showAlert(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  const resultDiv = document.getElementById('allocResult');
  resultDiv.innerHTML = '';
  resultDiv.appendChild(alertDiv);
  
  // Auto-dismiss after 5 seconds
  setTimeout(() => {
    alertDiv.classList.remove('show');
    setTimeout(() => alertDiv.remove(), 150);
  }, 5000);
}

// Export to PDF
async function exportToPdf() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(18);
    doc.setTextColor(102, 126, 234);
    doc.text('Student Allocation Report', 14, 22);
    
    // Add date
    doc.setFontSize(10);
    doc.setTextColor(100);
    const dateStr = new Date().toLocaleString();
    doc.text(`Generated: ${dateStr}`, 14, 30);
    
    // Get table data
    const res = await fetch('/allocator/allocations');
    const data = await res.json();
    
    if (data.length === 0) {
      doc.setFontSize(12);
      doc.text('No allocations found', 14, 45);
    } else {
      // Prepare table data
      const tableData = data.map(r => [
        r.allotment_id ?? 'N/A',
        r.student_id ?? 'N/A',
        r.student_name ?? 'N/A',
        r.course_name ?? 'N/A',
        r.college_name ?? 'N/A',
        r.allotment_status ?? 'N/A'
      ]);
      
      // Add table
      doc.autoTable({
        startY: 35,
        head: [['Allotment ID', 'Student ID', 'Student Name', 'Course', 'College', 'Status']],
        body: tableData,
        theme: 'striped',
        headStyles: {
          fillColor: [102, 126, 234],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [245, 247, 250]
        },
        margin: { top: 35 }
      });
      
      // Add footer with total count
      const finalY = doc.lastAutoTable.finalY || 35;
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Total Allocations: ${data.length}`, 14, finalY + 10);
    }
    
    // Save the PDF
    doc.save(`allocations_${new Date().getTime()}.pdf`);
    showAlert('PDF exported successfully', 'success');
  } catch (error) {
    console.error('Error exporting PDF:', error);
    showAlert('Failed to export PDF', 'danger');
  }
}

// Event listeners
document.getElementById('allocateForm').addEventListener('submit', runAllocate);
document.getElementById('refreshBtn').addEventListener('click', () => {
  fetchAllocations();
  updateStats();
});
document.getElementById('refreshStats').addEventListener('click', updateStats);
document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
document.getElementById('downloadBtn').addEventListener('click', () => {
  window.location.href = '/allocator/download';
});

// Initialize on page load
window.addEventListener('load', async () => {
  await fetchAllocations();
  await updateStats();
});
</script>
{% endblock %}